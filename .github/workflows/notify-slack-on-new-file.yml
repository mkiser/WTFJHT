- name: Determine file(s) and build Slack message
  id: files
  run: |
    if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
      echo "ðŸ§ª Manual run â€” using most recently modified file in _posts/"
      FILES=$(find _posts -type f -printf '%T@ %p\n' | sort -n | tail -1 | cut -d' ' -f2-)
    else
      echo "ðŸ” Push event â€” checking for new files"
      FILES=$(git diff --diff-filter=A --name-only HEAD^ HEAD _posts/)
    fi

    if [[ -z "$FILES" ]]; then
      echo "message=No new files to process." >> $GITHUB_OUTPUT
      exit 0
    fi

    MESSAGE=""
    for FILE in $FILES; do
      echo "ðŸ†• Processing: $FILE"

      TITLE=$(awk '/^---/{f=!f; next} f && /^title:/ {sub(/^title:[ ]*/, "", $0); print $0; exit}' "$FILE")
      DESCRIPTION=$(awk '/^---/{f=!f; next} f && /^description:/ {sub(/^description:[ ]*/, "", $0); print $0; exit}' "$FILE")
      URL="https://github.com/mkiser/WTFJHT/blob/master/${FILE}"
      MESSAGE+="ðŸ“¦ <${URL}|*${TITLE}: ${DESCRIPTION}*> â†’ GitHub\n"
    done

    echo -e "âœ… Slack message:\n$MESSAGE"

    MESSAGE="${MESSAGE//'%'/'%25'}"
    MESSAGE="${MESSAGE//$'\n'/'%0A'}"
    MESSAGE="${MESSAGE//$'\r'/'%0D'}"
    echo "message=$MESSAGE" >> $GITHUB_OUTPUT
