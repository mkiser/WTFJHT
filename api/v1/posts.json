---
---

{
  "version": "1.1",
  "lastUpdated" : "{{ 'now' | date: '%Y-%m-%d' }}",
  "todayLink": {{ site.url | append: site.baseurl | append: site.posts.first.url | jsonify }},
  "yesterdayLink": {%- for p in site.posts limit:1 offset:1 -%}{{ site.url | append: site.baseurl | append: p.url | jsonify }}{%- endfor -%},
  "posts" : [
    {%- for post in site.posts limit:15 -%}
    {%- assign abs = post.url | absolute_url -%}
    {%- assign enc_url = abs | uri_escape -%}
    {%- assign norm_title = post.title | strip -%}
    {%- assign norm_desc  = post.description | default: '' | strip -%}

    {%- assign full_share_text = 'What the fuck just happened today?' -%}
    {%- assign full_share_text = full_share_text | append: '
' | append: '
' | append: '⚡ ' | append: norm_title -%}
    {%- if norm_desc != '' -%}
      {%- assign full_share_text = full_share_text | append: ': ' | append: norm_desc -%}
    {%- endif -%}
    {%- assign full_share_text = full_share_text | append: '
' | append: '
' -%}
    {%- assign title_display = norm_title -%}
    {%- if norm_desc != '' -%}
      {%- assign title_display = title_display | append: ': ' | append: norm_desc -%}
    {%- endif -%}
    {%- assign day_number = post.slug | remove: 'day-' -%}

    {%- assign tracked_url = abs -%}
    {%- if site.share_ref -%}
      {%- assign joiner = '?' -%}
      {%- if abs contains '?' -%}{%- assign joiner = '&' -%}{%- endif -%}
      {%- assign tracked_url = abs | append: joiner | append: site.share_ref -%}
    {%- endif -%}
    {%- assign enc_tracked_url = tracked_url | uri_escape -%}

    {%- assign enc_preface = 'What the fuck just happened today?' | uri_escape -%}
    {%- assign enc_bolt = '⚡ ' | uri_escape -%}
    {%- assign enc_title = norm_title | uri_escape -%}
    {%- assign enc_sep = ': ' | uri_escape -%}
    {%- assign enc_desc = norm_desc | uri_escape -%}
    {%- assign NL2_web = '%0A%0A' -%}

    {%- capture enc_full_share_text -%}
      {{ enc_preface }}{{ NL2_web }}{{ enc_bolt }}{{ enc_title }}{%- if norm_desc != '' -%}{{ enc_sep }}{{ enc_desc }}{%- endif -%}{{ NL2_web }}
    {%- endcapture -%}
    {%- assign enc_full_share_text = enc_full_share_text | strip -%}
    {%- assign enc_full_share_with_url = enc_full_share_text | append: enc_tracked_url -%}

    {%- capture enc_full_share_text_threads -%}
      {{ enc_preface }}{{ NL2_web }}{{ enc_title }}{%- if norm_desc != '' -%}{{ enc_sep }}{{ enc_desc }}{%- endif -%}{{ NL2_web }}
    {%- endcapture -%}
    {%- assign enc_full_share_text_threads = enc_full_share_text_threads | strip -%}
    {%- assign enc_full_share_with_url_threads = enc_full_share_text_threads | append: enc_tracked_url -%}

    {%- assign NL = '%0D%0A' -%}
    {%- assign NL2 = '%0D%0A%0D%0A' -%}

    {%- assign mail_subject_raw = 'From WTF Just Happened Today?: ' | append: norm_title -%}
    {%- if norm_desc != '' -%}
      {%- assign mail_subject_raw = mail_subject_raw | append: ': ' | append: norm_desc -%}
    {%- endif -%}
    {%- assign enc_mail_subject = mail_subject_raw | uri_escape -%}

    {%- assign reddit_title = norm_title -%}
    {%- if norm_desc != '' -%}
      {%- assign reddit_title = reddit_title | append: ': ' | append: norm_desc -%}
    {%- endif -%}
    {%- assign enc_reddit_title = reddit_title | uri_escape -%}

    {%- assign enc_body_line1 = "From today's edition WTF Just Happened Today?" | uri_escape -%}
    {%- assign enc_mail_body = enc_body_line1 -%}
    {%- if post.todayInOneSentence -%}
      {%- assign enc_tios_prefix = 'Today in one sentence: ' | uri_escape -%}
      {%- assign enc_tios = post.todayInOneSentence | strip | uri_escape -%}
      {%- assign enc_mail_body = enc_mail_body | append: NL2 | append: enc_tios_prefix | append: enc_tios -%}
    {%- endif -%}
    {%- assign enc_mail_body = enc_mail_body | append: NL2 | append: enc_tracked_url -%}

    {
      "id"   : {{ post.id | jsonify }},
      "slug" : {{ post.slug | jsonify }},
      "title" : {{ post.title | jsonify }},
      "description"  : {{ post.description | jsonify }},
      "titleDisplay": {{ title_display | jsonify }},
      "contentHtml"  : {{ post.content | jsonify }},
      "dayLabel": {{ norm_title | jsonify }},
      "dayNumber": {{ day_number | jsonify }},
      "url"  : "{{ site.url }}{{ site.baseurl }}{{ post.url }}",
      {%- if post.image contains '/uploads/' -%}
      "image" : "{{ site.url }}{{ site.baseurl }}{{ post.image }}",
      {%- else -%}
      "image" : "",
      {%- endif -%}
      {%- if post.todayInOneSentence -%}
      "todayInOneSentence" : {{ post.todayInOneSentence | jsonify }},
      {%- endif -%}
      {%- if post.author -%}
      "author" : "{{ post.author }}",
      {%- endif -%}
      "copyText": {{ full_share_text | append: tracked_url | jsonify }},
      "share": {
        "x": "https://twitter.com/intent/tweet?text={{ enc_full_share_text }}&url={{ enc_tracked_url }}&via=WTFJHT",
        "bluesky": "https://bsky.app/intent/compose?text={{ enc_full_share_with_url }}",
        "threads": "https://threads.com/intent/post?text={{ enc_full_share_with_url_threads }}",
        "mastodon": "https://mastodonshare.com/?text={{ enc_full_share_text }}&url={{ enc_tracked_url }}",
        "facebook": "https://www.facebook.com/sharer/sharer.php?u={{ enc_tracked_url }}",
        "linkedin": "https://www.linkedin.com/sharing/share-offsite/?url={{ enc_tracked_url }}",
        "reddit": "https://www.reddit.com/submit?url={{ enc_tracked_url }}&title={{ enc_reddit_title }}",
        "whatsapp": "https://wa.me/?text={{ enc_full_share_with_url }}",
        "telegram": "https://t.me/share/url?url={{ enc_tracked_url }}&text={{ enc_full_share_text }}",
        "email": "mailto:?subject={{ enc_mail_subject }}&body={{ enc_mail_body }}"
      },

      {%- if post.podcast.file and post.podcast.file != '' -%}
      "audio": {
        "url": "{{ site.cloudfront_url }}{{ post.podcast.file }}",
        "duration": {{ post.podcast.duration | default: '' | jsonify }},
        "length": {{ post.podcast.length | default: 0 }}
      },
      {%- endif -%}

      {%- assign _words = post.content | strip_html | number_of_words -%}
      {%- assign _reading_speed = 200 -%}
      {%- assign _minutes_decimal = _words | times: 1.0 | divided_by: _reading_speed -%}
      {%- assign _minutes_whole = _minutes_decimal | floor -%}
      {%- assign _minutes_fraction = _minutes_decimal | minus: _minutes_whole -%}
      {%- if _minutes_whole < 1 and _minutes_fraction < 0.5 -%}{%- assign _display_minutes = 1 -%}{%- assign _half = false -%}
      {%- elsif _minutes_fraction < 0.25 -%}{%- assign _display_minutes = _minutes_whole -%}{%- assign _half = false -%}
      {%- elsif _minutes_fraction < 0.75 -%}{%- assign _display_minutes = _minutes_whole -%}{%- assign _half = true -%}
      {%- else -%}{%- assign _display_minutes = _minutes_whole | plus: 1 -%}{%- assign _half = false -%}
      {%- endif -%}
      {%- capture _read_sentence -%}This edition is {{ _words }} words, a {% if _half %}{{ _display_minutes }}½-minute{% else %}{{ _display_minutes }}-minute{% endif %} read.{%- endcapture -%}
      "readTime": {
        "words": {{ _words }},
        "minutes": {%- if _half -%}{{ _display_minutes }}.5{%- else -%}{{ _display_minutes }}{%- endif -%},
        "sentence": {{ _read_sentence | strip | normalize_whitespace | jsonify }}
      },

      {%- if post.currentMood and post.currentMood != '' -%}
      "currentMood": {{ post.currentMood | jsonify }},
      {%- endif -%}
      {%- if post.editorsNote and post.editorsNote != '' -%}
      "editorsNote": {{ post.editorsNote | jsonify }},
      {%- endif -%}

      "date"  : {
        "isoDate": "{{ post.date | date: '%Y-%m-%d' }}",
        "isoDateTime": "{{ post.date }}",
        "day": "{{ post.date | date: '%d' }}",
        "month": "{{ post.date | date: '%B' }}",
        "year": "{{ post.date | date: '%Y' }}"
      }
    }{%- unless forloop.last -%},{%- endunless -%}
    {%- endfor -%}
 ]
}
